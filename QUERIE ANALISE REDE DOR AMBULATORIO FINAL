
------------------------BASE AMBULATORIAL PARTE 2---------------------------------------------

-- BASE DOMICILIAR
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_DOMICILIAR_LA AS 
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'DOMICILIAR' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO
  
  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
  FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR

    
    
LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA



WHERE FLG_INTERNACAO = 'N'                                                                        -- TIRA INTERNAÇÃO
  AND (D.COD_PRESTADOR IS NOT NULL OR DSC_SUBGRUPO_SERVICO = 'DOMICILIAR')                        -- CONSIDERA DOMICILIAR
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'


GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;


-- BASE PS
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_PS_LA AS 
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'PS' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
 , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR

LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'S'                                                                                -- CONSIDERA PS
  AND A.FLG_INTERNACAO = 'N'                                                                        -- TIRA INTERNAÇÃO  
  AND D.COD_PRESTADOR IS NULL                                                                       -- TIRA DOMICILIAR
  AND A.DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                        -- TIRA DOMICILIAR
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;



-- BASE PROCEDIMENTO
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_PROCEDIMENTO_LA AS 
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'PROCEDIMENTO' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR

LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                              -- TIRA PS
  AND B.FLG_PROCEDIMENTO = 'S'                                                                    -- CONSIDERA PROCEDIMENTO
  AND A.FLG_INTERNACAO = 'N'                                                                      -- TIRA INTERNAÇÃO
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                        -- TIRA DOMICILIAR
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;



-- QUIMIOTERAPIA
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_QUIMIO_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'QUIMIO' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP

LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                            -- TIRA PS
  AND B.FLG_PROCEDIMENTO = 'N'                                                                  -- TIRA PROCEDIMENTO  
  AND A.FLG_INTERNACAO = 'N'                                                                    -- TIRA INTERNAÇÃO
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                      -- TIRA DOMICILIAR
  AND Q.NUM_VPP IS NOT NULL                                                                     -- CONSIDERA QUIMIO
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;



-- CODIGOS RADIOTERAPIA
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO_LA AS 
WITH BASE_1 AS (
  SELECT 
    COD_SERVICO
    , DSC_SERVICO_COMPLETA
    , DSC_GRUPO_ESTATISTICO
    , DSC_SUB_GRUPO_SERVICO
    , DSC_GRUPO_SERVICO
    , DSC_SUB_GRUPO_SERVICO_AMB
    , DSC_GRUPO_SERVICO_AMB
    , DSC_CAPITULO_SERVICO_AMB 
  FROM `self-service-saude-prd.REF_SAUDE_SERVICO.TB_CAD_SERVICO` 
  WHERE DSC_SUB_GRUPO_SERVICO = 'RADIOTERAPIA' OR COD_SERVICO = 35800640
    OR DSC_GRUPO_ESTATISTICO = 'RADIOTERAPIA' OR DSC_SERVICO_COMPLETA LIKE '%RADIOTERAPIA%' 
    OR DSC_SERVICO_COMPLETA LIKE '%BRAQUITERAPIA%' OR DSC_SERVICO_COMPLETA LIKE '%TELETERAPIA%' 
    OR DSC_SERVICO_COMPLETA LIKE '%RADIOCIRURGIA %' OR DSC_SERVICO_COMPLETA LIKE '%RADIOIMPLANTE%' 
    OR DSC_SERVICO_COMPLETA LIKE '%IODO 125%' OR DSC_SERVICO_COMPLETA LIKE '%RADIO 223%' OR DSC_SERVICO_COMPLETA LIKE '%BETATERAPIA%' 
    OR DSC_SERVICO_COMPLETA LIKE '%RADITERAPIA%' 
    OR DSC_SUB_GRUPO_SERVICO_AMB = 'RADIOTERAPIA CLINICA (APLICACAO)' 
    OR DSC_GRUPO_SERVICO_AMB = 'RADIOTERAPIA' 
    OR COD_SERVICO = 35800569 
    OR COD_SERVICO = 64617629
    OR COD_SERVICO = 64613569
)
, BASE_2 AS (
  SELECT 
    * 
  FROM BASE_1 
  WHERE DSC_SERVICO_COMPLETA NOT LIKE '%IODOTERAPIA%' 
  AND DSC_GRUPO_SERVICO NOT IN ('CONSULTA','DIAGNOSE','DIARIAS','TAXA','TAXA DE SALA') 
  AND DSC_GRUPO_ESTATISTICO != 'TAXA DE USO DE EQUIPAMENTO'
)
, BASE_3 AS (
  SELECT DISTINCT 
    COD_SERVICO 
  FROM `self-service-saude.OW_LAND_SAU_PRD.PAC_SERV_PRINCIPAL` 
  WHERE COD_SERV_PRINCIPAL IN (SELECT COD_SERVICO FROM BASE_2)
)
, BASE_4 AS (
  SELECT 
    COD_SERVICO
    , DSC_SERVICO_COMPLETA
    , DSC_GRUPO_ESTATISTICO
    , DSC_SUB_GRUPO_SERVICO
    , DSC_GRUPO_SERVICO
    , DSC_SUB_GRUPO_SERVICO_AMB
    , DSC_GRUPO_SERVICO_AMB
    , DSC_CAPITULO_SERVICO_AMB 
  FROM `self-service-saude.REF_SAUDE_SERVICO.TB_CAD_SERVICO` 
  WHERE COD_SERVICO IN (SELECT COD_SERVICO FROM BASE_3) AND DSC_SERVICO_COMPLETA NOT LIKE '%IODOTERAPIA%' 
  AND DSC_GRUPO_ESTATISTICO != 'TAXA DE USO DE EQUIPAMENTO' 
)
, BASE_5 AS (
  SELECT * FROM BASE_2
  UNION ALL
  SELECT * FROM BASE_4
)
SELECT DISTINCT 
  * 
FROM BASE_5 
WHERE DSC_SERVICO_COMPLETA NOT LIKE '%QUIMIOTERAPIA%'
AND COD_SERVICO NOT IN (
  64619346,
  64619354,
  64619362,
  64619370,
  64619389,
  64621014,
  64623025,
  64623033,
  64623041,
  64623050,
  96022779,
  96022620
  )
ORDER BY 6,7
;

-- BASE RADIOTERAPIA
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_RADIO_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'RADIO' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO

  LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                          -- TIRA PS
  AND FLG_PROCEDIMENTO = 'N'                                                                  -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                    -- TIRA INTERNAÇÃO 
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                    -- TIRA DOMICILIAR 
  AND Q.NUM_VPP IS NULL                                                                       -- TIRA QUIMIO
  AND R.COD_SERVICO IS NOT NULL                                                               -- CONSIDERA RADIO
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;



-- BASE HEMODIALISE 
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_HEMODIALISE_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'HEMODIALISE' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO

LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                        -- TIRA PS
  AND FLG_PROCEDIMENTO = 'N'                                                                -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                  -- TIRA INTERNAÇÃO
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                  -- TIRA DOMICILIAR 
  AND Q.NUM_VPP IS NULL                                                                     -- TIRA QUIMIO  
  AND R.COD_SERVICO IS NULL                                                                 -- TIRA RADIO 
  AND FLG_TERAPIA_HEMODIALISE = 'S'                                                         -- CONSIDERA HEMODIALISE
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'   
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;



-- BASE DEMAIS TERAPIAS MÉDICAS
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_DEMAIS_TERAPIAS_MEDICAS_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'DEMAIS TERAPIAS MÉDICAS' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO

 LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA
   
WHERE B.FLG_PS = 'N'                                                                        -- TIRA PS 
  AND FLG_PROCEDIMENTO = 'N'                                                                -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                  -- TIRA INTERNAÇÃO 
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                  -- TIRA DOMICILIAR 
  AND Q.NUM_VPP IS NULL                                                                     -- TIRA QUIMIO
  AND R.COD_SERVICO IS NULL                                                                 -- TIRA RADIO
  AND FLG_TERAPIA_HEMODIALISE = 'N'                                                         -- TIRA HEMODIALISE
  AND (FLG_TERAPIA_DIALISE ='S' OR FLG_TERAPIA_HEMOTERAPIA = 'S')                           -- CONSIDERA DIALISE E HEMOTERAPIA
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;





-- CÓDIGOS TERAPIAS NÃO MÉDICAS 
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_CODIGOS_TERAPIAS_N_MEDICAS_LA AS
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT DISTINCT 
  A.COD_SERVICO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN `self-service-saude.SANDBOX_GERAC.LT_TB_PLANO_AJUSTADO_CAPITATION` P
  ON A.NME_PLANO = P.NME_PLANO
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO
WHERE B.FLG_PS = 'N'                                                                        -- TIRA PS 
  AND FLG_PROCEDIMENTO = 'N'                                                                -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                  -- TIRA INTERNAÇÃO 
  AND (D.COD_PRESTADOR IS NULL AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR')                     -- TIRA DOMICILIAR 
  AND Q.NUM_VPP IS NULL                                                                     -- TIRA QUIMIO
  AND R.COD_SERVICO IS NULL                                                                 -- TIRA RADIO
  AND FLG_TERAPIA_HEMODIALISE = 'N'                                                         -- TIRA HEMODIALISE
  AND FLG_TERAPIA_DIALISE ='N' 
  and FLG_TERAPIA_HEMOTERAPIA = 'N'                                                          -- TIRA DIALISE E HEMOTERAPIA
  AND (A.COD_SERVICO = 31601014                                                               -- CONSIDERA TERAPIAS NÃO MÉDICAS
        OR A.DSC_GRUPO_SERVICO = 'TERAPIA' 
        OR (A.DSC_GRUPO_SERVICO = 'PACOTE' AND A.DSC_SUBGRUPO_SERVICO IN ('TERAPIA COM HM','TERAPIA SEM HM'))
        OR (A.DSC_GRUPO_SERVICO = 'PACOTE' AND A.DSC_SUBGRUPO_SERVICO = 'PROJETOS DAS AREAS' 
            AND A.COD_SERVICO IN (SELECT COD_SERVICO FROM `self-service-saude.SANDBOX_GERAC.TB_LISTA_CLASSIFICACAO_SERVICO_REAJUSTE_MASSIFICADOS` 
                                                    WHERE CLASSF_FINAL_SIMULADOR LIKE '%TERAPIA%')
          )
      )
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
;

-- BASE TERAPIAS NÃO MÉDICAS
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TERAPIAS_N_MEDICAS_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

  A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'TERAPIAS NÃO MÉDICAS' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO


 LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                        -- TIRA PS 
  AND FLG_PROCEDIMENTO = 'N'                                                                -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                  -- TIRA INTERNAÇÃO 
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                  -- TIRA DOMICILIAR 
  AND Q.NUM_VPP IS NULL                                                                     -- TIRA QUIMIO
  AND R.COD_SERVICO IS NULL                                                                 -- TIRA RADIO
  AND FLG_TERAPIA_HEMODIALISE = 'N'                                                         -- TIRA HEMODIALISE
  AND FLG_TERAPIA_DIALISE ='N' 
  AND FLG_TERAPIA_HEMOTERAPIA = 'N'                                                          -- TIRA DIALISE E HEMOTERAPIA
  AND (A.COD_SERVICO = 31601014                                                               -- CONSIDERA TERAPIAS NÃO MÉDICAS
        OR A.DSC_GRUPO_SERVICO = 'TERAPIA' 
        OR (A.DSC_GRUPO_SERVICO = 'PACOTE' AND A.DSC_SUBGRUPO_SERVICO IN ('TERAPIA COM HM','TERAPIA SEM HM'))
        OR (A.DSC_GRUPO_SERVICO = 'PACOTE' AND A.DSC_SUBGRUPO_SERVICO = 'PROJETOS DAS AREAS' 
            AND A.COD_SERVICO IN (SELECT COD_SERVICO FROM `self-service-saude.SANDBOX_GERAC.TB_LISTA_CLASSIFICACAO_SERVICO_REAJUSTE_MASSIFICADOS` 
                                                    WHERE CLASSF_FINAL_SIMULADOR LIKE '%TERAPIA%')
          )
      )
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;


-- BASE EXAMES
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_EXAMES_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'EXAMES' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO
LEFT JOIN SANDBOX_GERAC.LT_CODIGOS_TERAPIAS_N_MEDICAS NM
  ON A.COD_SERVICO = NM.COD_SERVICO

 LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                                                -- TIRA PS
  AND B.FLG_PROCEDIMENTO = 'N'                                                                                      -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                                          -- TIRA INTERNAÇÃO
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                                          -- TIRA DOMICILIAR 
  AND Q.NUM_VPP IS NULL                                                                                             -- TIRA QUIMIO  
  AND R.COD_SERVICO IS NULL                                                                                         -- TIRA RADIO
  AND B.FLG_TERAPIA_DIALISE = 'N'                                                                                   -- TIRA DIALISE
  AND B.FLG_TERAPIA_HEMOTERAPIA = 'N'                                                                               -- TIRA HEMOTERAPIA
  AND B.FLG_TERAPIA_HEMODIALISE = 'N'                                                                               -- TIRA HEMODIALISE
  AND NM.COD_SERVICO IS NULL                                                                                        -- TIRA TERAPIAS NÃO MÉDICAS
  AND (A.DSC_GRUPO_SERVICO = 'DIAGNOSE' OR A.DSC_SUBGRUPO_SERVICO IN ('DIAGNOSE COM HM', 'DIAGNOSE SEM HM'))        -- CONSIDERA EXAMES
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;



-- CÓDIGOS CONSULTA 
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_CODIGOS_CONSULTAS_LA AS
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT DISTINCT 
  A.COD_SERVICO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN `self-service-saude.SANDBOX_GERAC.LT_TB_PLANO_AJUSTADO_CAPITATION` P
  ON A.NME_PLANO = P.NME_PLANO
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO
LEFT JOIN SANDBOX_GERAC.LT_CODIGOS_TERAPIAS_N_MEDICAS NM
  ON A.COD_SERVICO = NM.COD_SERVICO
WHERE B.FLG_PS = 'N'                                                                                                                          -- TIRA PS
  AND B.FLG_PROCEDIMENTO = 'N'                                                                                                                -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                                                                    -- TIRA INTERNAÇÃO
  AND (D.COD_PRESTADOR IS NULL AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR')                                                                       -- TIRA DOMICILIAR
  AND Q.NUM_VPP IS NULL                                                                                                                       -- TIRA QUIMIO
  AND R.COD_SERVICO IS NULL                                                                                                                   -- TIRA RADIO
  AND B.FLG_TERAPIA_DIALISE = 'N'                                                                                                             -- TIRA DIALISE
  AND B.FLG_TERAPIA_HEMOTERAPIA = 'N'                                                                                                         -- TIRA HEMOTERAPIA
  AND B.FLG_TERAPIA_HEMODIALISE = 'N'                                                                                                         -- TIRA HEMODIALISE
  AND A.DSC_GRUPO_SERVICO != 'DIAGNOSE' 
  AND A.DSC_SUBGRUPO_SERVICO NOT IN ('DIAGNOSE COM HM', 'DIAGNOSE SEM HM')                             -- TIRA EXAMES
  AND NM.COD_SERVICO IS NULL                                                                                                                  -- TIRA TERAPIAS NÃO MÉDICAS
  AND (DSC_SUBGRUPO_SERVICO IN ('NORMAL', 'ATENDIMENTO OU CONSULTA')                                                                          -- CONSIDERA CONSULTAS
        OR (UPPER(TRIM(DSC_SUBGRUPO_SERVICO)) IN ('PROGRAMAS SUGSP', 'PROJETOS DAS AREAS') AND DSC_SERVICO LIKE '%CONSULTA%')                 
        OR (UPPER(TRIM(DSC_SUBGRUPO_SERVICO)) IN ('PROGRAMAS SUGSP', 'PROJETOS DAS AREAS') AND DSC_SERVICO LIKE '%ATENDIMENTO%')
      )
  AND DSC_SERVICO NOT LIKE '%FISIOT%' 
  AND DSC_SERVICO NOT LIKE '%DOMI%' 
  AND DSC_SERVICO NOT LIKE '%NUTRI%' 
  AND DSC_SERVICO NOT LIKE '%FONO%' 
  AND DSC_SERVICO NOT LIKE '%PRONTO SOCORRO%' 
  AND DSC_SERVICO NOT LIKE '%PS %' 
  AND DSC_SERVICO NOT LIKE '%EMERGENCIA%' 
  AND A.COD_SERVICO NOT IN (64624056,64624064,64623513,64623580,64624650) 
  AND DSC_SERVICO NOT LIKE '%CAPITATION%'
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
;

-- BASE CONSULTAS
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_CONSULTAS_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'CONSULTAS' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO
LEFT JOIN SANDBOX_GERAC.LT_CODIGOS_TERAPIAS_N_MEDICAS NM
  ON A.COD_SERVICO = NM.COD_SERVICO

 LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                                                                          -- TIRA PS
  AND B.FLG_PROCEDIMENTO = 'N'                                                                                                                -- TIRA PROCEDIMENTO
  AND FLG_INTERNACAO = 'N'                                                                                                                    -- TIRA INTERNAÇÃO
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                                                                                    -- TIRA DOMICILIAR
  AND Q.NUM_VPP IS NULL                                                                                                                       -- TIRA QUIMIO
  AND R.COD_SERVICO IS NULL                                                                                                                   -- TIRA RADIO
  AND B.FLG_TERAPIA_DIALISE = 'N'                                                                                                             -- TIRA DIALISE
  AND B.FLG_TERAPIA_HEMOTERAPIA = 'N'                                                                                                         -- TIRA HEMOTERAPIA
  AND B.FLG_TERAPIA_HEMODIALISE = 'N'                                                                                                         -- TIRA HEMODIALISE
  AND A.DSC_GRUPO_SERVICO != 'DIAGNOSE' 
  AND A.DSC_SUBGRUPO_SERVICO NOT IN ('DIAGNOSE COM HM', 'DIAGNOSE SEM HM')                             -- TIRA EXAMES
  AND NM.COD_SERVICO IS NULL                                                                                                                  -- TIRA TERAPIAS NÃO MÉDICAS
  AND (DSC_SUBGRUPO_SERVICO IN ('NORMAL', 'ATENDIMENTO OU CONSULTA')                                                                          -- CONSIDERA CONSULTAS
        OR (UPPER(TRIM(DSC_SUBGRUPO_SERVICO)) IN ('PROGRAMAS SUGSP', 'PROJETOS DAS AREAS') AND DSC_SERVICO LIKE '%CONSULTA%')                 
        OR (UPPER(TRIM(DSC_SUBGRUPO_SERVICO)) IN ('PROGRAMAS SUGSP', 'PROJETOS DAS AREAS') AND DSC_SERVICO LIKE '%ATENDIMENTO%')
      )
  AND DSC_SERVICO NOT LIKE '%FISIOT%' 
  AND DSC_SERVICO NOT LIKE '%DOMI%' 
  AND DSC_SERVICO NOT LIKE '%NUTRI%' 
  AND DSC_SERVICO NOT LIKE '%FONO%' 
  AND DSC_SERVICO NOT LIKE '%PRONTO SOCORRO%' 
  AND DSC_SERVICO NOT LIKE '%PS %' 
  AND DSC_SERVICO NOT LIKE '%EMERGENCIA%' 
  AND A.COD_SERVICO NOT IN (64624056,64624064,64623513,64623580,64624650) 
  AND DSC_SERVICO NOT LIKE '%CAPITATION%'
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;






-- BASE MEDICAMENTOS
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_MEDICAMENTOS_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'MEDICAMENTOS' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO
LEFT JOIN SANDBOX_GERAC.LT_CODIGOS_CONSULTAS C
  ON A.COD_SERVICO = C.COD_SERVICO
LEFT JOIN SANDBOX_GERAC.LT_CODIGOS_TERAPIAS_N_MEDICAS NM
  ON A.COD_SERVICO = NM.COD_SERVICO

 LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                                                  -- TIRA PS
  AND B.FLG_PROCEDIMENTO = 'N'                                                                                        -- TIRA PROCEDIMENTO 
  AND A.FLG_INTERNACAO = 'N'                                                                                          -- TIRA INTERNAÇÕES
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                               -- TIRA DOMICILIAR  
  AND Q.NUM_VPP IS NULL                                                                                               -- TIRA QUIMIO
  AND R.COD_SERVICO IS NULL                                                                                           -- TIRA RADIO
  AND B.FLG_TERAPIA_DIALISE = 'N'                                                                                     -- TIRA DIALISE
  AND B.FLG_TERAPIA_HEMOTERAPIA = 'N'                                                                                 -- TIRA HEMOTERAPIA
  AND B.FLG_TERAPIA_HEMODIALISE = 'N'                                                                                 -- TIRA HEMODIALISE
  AND A.DSC_GRUPO_SERVICO != 'DIAGNOSE' 
  AND A.DSC_SUBGRUPO_SERVICO NOT IN ('DIAGNOSE COM HM', 'DIAGNOSE SEM HM')     -- TIRA EXAMES  
  AND C.COD_SERVICO IS NULL                                                                                           -- TIRA CONSULTA
  AND NM.COD_SERVICO IS NULL                                                                                          -- TIRA TERAPIAS NÃO MÉDICAS
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_GRUPO_SERVICO = 'MEDICAMENTO'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;

-- BASE OUTROS AMBULATORIO
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_OUTROS_AMB_LA AS 
WITH SOLIC_QUIMIO AS (
  SELECT DISTINCT 
    NUM_VPP
  FROM `self-service-saude-prd.TRU_SAUDE_PROVPP.SOLIC_QUIMIOTERAPIA`
)
SELECT

A.DSC_FAIXA_ETARIA_BENEFICIARIO,
  A.DSC_CLASSIFICACAO_PRESTADOR,
  A.SGL_UF_PRESTADOR,

  FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO
  , FORMAT_DATE('%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS MES
  , FORMAT_DATE('%Y%m', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) AS ANO_MES
  , 'OUTROS' AS BASE
  , A.COD_ANALITICO_BENEFICIARIO
  , A.NME_FANTASIA_PRESTADOR
  , A.DSC_GRUPO_ECONOMICO_PRESTADOR
  , A.DSC_CARTEIRA_EMPRESA
  , PLAN.NME_PLANO_AJUSTADO

  , COUNT(DISTINCT CONCAT(A.COD_ANALITICO_BENEFICIARIO, A.DAT_ATENDIMENTO_EFETIVO_SINISTRO)) AS TOTAL_QTD_ATENDIMENTO
  , SUM(QTD_SERVICO_PAGO) AS TOTAL_QTD_SERVICO
  , SUM(A.VLR_PAGO_SERVICO) AS TOTAL_SINISTRO
FROM `self-service-saude-prd.REF_SAUDE_ESTRATEGIA_SINISTRO.TB_FAT_ITEM_SERVICO_SINISTRO` A 
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_FAT_NAO_INTERNACAO` B 
  ON B.COD_ANALITICO_BENEFICIARIO = A.COD_ANALITICO_BENEFICIARIO 
  AND B.DAT_ATENDIMENTO_EFETIVO_SINISTRO = A.DAT_ATENDIMENTO_EFETIVO_SINISTRO
LEFT JOIN `self-service-saude.TRU_SAUDE_CONTROLE_PRECO_SINISTRO_PRD.TB_ESP_PRESTADOR_DOMICILIAR` D
  ON A.COD_PRESTADOR = D.COD_PRESTADOR
LEFT JOIN SOLIC_QUIMIO Q
  ON A.NUM_VPP = Q.NUM_VPP
LEFT JOIN SANDBOX_GERAC.LT_ONCO_CODIGOS_RADIO R
  ON A.COD_SERVICO = R.COD_SERVICO
LEFT JOIN SANDBOX_GERAC.LT_CODIGOS_CONSULTAS C
  ON A.COD_SERVICO = C.COD_SERVICO
LEFT JOIN SANDBOX_GERAC.LT_CODIGOS_TERAPIAS_N_MEDICAS NM
  ON A.COD_SERVICO = NM.COD_SERVICO

 LEFT JOIN self-service-saude.SANDBOX_GERAC.TB_PLANO_AJUSTADO_COM_SOMPO_LA PLAN
  ON A.NME_PLANO = PLAN.NME_PLANO #TRAZ O NME_PLANO_AJUSTADO DA TABELA DE DEPARA

WHERE B.FLG_PS = 'N'                                                                                                  -- TIRA PS
  AND B.FLG_PROCEDIMENTO = 'N'                                                                                        -- TIRA PROCEDIMENTO 
  AND A.FLG_INTERNACAO = 'N'                                                                                          -- TIRA INTERNAÇÕES
  AND D.COD_PRESTADOR IS NULL 
  AND DSC_SUBGRUPO_SERVICO != 'DOMICILIAR'                                               -- TIRA DOMICILIAR  
  AND Q.NUM_VPP IS NULL                                                                                               -- TIRA QUIMIO
  AND R.COD_SERVICO IS NULL                                                                                           -- TIRA RADIO
  AND B.FLG_TERAPIA_DIALISE = 'N'                                                                                     -- TIRA DIALISE
  AND B.FLG_TERAPIA_HEMOTERAPIA = 'N'                                                                                 -- TIRA HEMOTERAPIA
  AND B.FLG_TERAPIA_HEMODIALISE = 'N'                                                                                 -- TIRA HEMODIALISE
  AND A.DSC_GRUPO_SERVICO != 'DIAGNOSE' 
  AND A.DSC_SUBGRUPO_SERVICO NOT IN ('DIAGNOSE COM HM', 'DIAGNOSE SEM HM')     -- TIRA EXAMES  
  AND C.COD_SERVICO IS NULL                                                                                           -- TIRA CONSULTA
  AND NM.COD_SERVICO IS NULL                                                                                          -- TIRA TERAPIAS NÃO MÉDICAS
  AND FORMAT_DATE('%Y', A.DAT_ATENDIMENTO_EFETIVO_SINISTRO) >= '2018'
  AND A.DSC_GRUPO_SERVICO != 'MEDICAMENTO'
  AND A.DSC_TIPO_SINISTRO = 'REDE'
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12
;

----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
------------------------BASE AMBULATORIAL PARTE 3---------------------------------------------


-- BASE TOTAL
CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TOTAL_ANALISE_DOR_LA AS 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_DOMICILIAR_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_PS_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_PROCEDIMENTO_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_QUIMIO_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_RADIO_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_HEMODIALISE_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_DEMAIS_TERAPIAS_MEDICAS_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TERAPIAS_N_MEDICAS_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_EXAMES_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_CONSULTAS_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_MEDICAMENTOS_LA
UNION ALL 
SELECT 
  *
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_OUTROS_AMB_LA
;

----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
--CRIA BASE AMBULATORIAL COM OS CALCULOS DE VARIAÇÃO PARA USAR NO PAINEL DO DATA STUDIO----------------

CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TOTAL_ANALISE_DOR_DATASTUDIO_LA AS

WITH TABELA2 AS 
(
  WITH TABELA1 AS   
    (
    #PRIMEIRO SELECT, CRIA O CAMPO QTDE_ATENDIMENTO, QUE É A JUNÇÃO DE TOTAL_QTD_ATENDIMENTO E TOTAL_QTD_SERVICO
    SELECT
    DSC_FAIXA_ETARIA_BENEFICIARIO,
    DSC_CLASSIFICACAO_PRESTADOR,
    SGL_UF_PRESTADOR,
    ANO
  , MES
  , ANO_MES
  , BASE 
  , DSC_CARTEIRA_EMPRESA
  , NME_PLANO_AJUSTADO

  , SUM(CASE WHEN BASE IN ('EXAMES', 'CONSULTAS', 'TERAPIAS NÃO MÉDICAS') THEN TOTAL_QTD_SERVICO 
        ELSE             
        TOTAL_QTD_ATENDIMENTO END) 
        AS TOTAL_QUANTIDADE,
    SUM(TOTAL_SINISTRO) AS TOTAL_SINISTRO,
    COUNT(DISTINCT COD_ANALITICO_BENEFICIARIO) 
      AS TOTAL_SINISTRADOS
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TOTAL_ANALISE_DOR_LA
GROUP BY 1,2,3,4,5,6,7,8,9
    )

#SEGUNDO SELECT, CRIA AS COLUNAS SE SOMA POR ANO PARA USAR NO DATA STUDIO
SELECT 
 DSC_FAIXA_ETARIA_BENEFICIARIO,
    DSC_CLASSIFICACAO_PRESTADOR,
    SGL_UF_PRESTADOR,
   ANO
  , MES
  , ANO_MES
  , BASE 
  , DSC_CARTEIRA_EMPRESA
  , NME_PLANO_AJUSTADO,
 
#TOTAL_SINISTRO
CASE WHEN ANO = '2018' THEN TOTAL_SINISTRO ELSE 0 END AS TOTAL_SINISTRO_2018,
CASE WHEN ANO = '2019' THEN TOTAL_SINISTRO ELSE 0 END AS TOTAL_SINISTRO_2019,
CASE WHEN ANO = '2020' THEN TOTAL_SINISTRO ELSE 0 END AS TOTAL_SINISTRO_2020,
CASE WHEN ANO = '2021' THEN TOTAL_SINISTRO ELSE 0 END AS TOTAL_SINISTRO_2021,
CASE WHEN ANO = '2022' THEN TOTAL_SINISTRO ELSE 0 END AS TOTAL_SINISTRO_2022,

#TOTAL_QUANTIDADE
CASE WHEN ANO = '2018' THEN TOTAL_QUANTIDADE ELSE 0 END AS TOTAL_QUANTIDADE_2018,
CASE WHEN ANO = '2019' THEN TOTAL_QUANTIDADE ELSE 0 END AS TOTAL_QUANTIDADE_2019,
CASE WHEN ANO = '2020' THEN TOTAL_QUANTIDADE ELSE 0 END AS TOTAL_QUANTIDADE_2020,
CASE WHEN ANO = '2021' THEN TOTAL_QUANTIDADE ELSE 0 END AS TOTAL_QUANTIDADE_2021,
CASE WHEN ANO = '2022' THEN TOTAL_QUANTIDADE ELSE 0 END AS TOTAL_QUANTIDADE_2022,

#TOTAL_SINISTRADOS
CASE WHEN ANO = '2018' THEN TOTAL_SINISTRADOS ELSE 0 END AS TOTAL_SINISTRADOS_2018,
CASE WHEN ANO = '2019' THEN TOTAL_SINISTRADOS ELSE 0 END AS TOTAL_SINISTRADOS_2019,
CASE WHEN ANO = '2020' THEN TOTAL_SINISTRADOS ELSE 0 END AS TOTAL_SINISTRADOS_2020,
CASE WHEN ANO = '2021' THEN TOTAL_SINISTRADOS ELSE 0 END AS TOTAL_SINISTRADOS_2021,
CASE WHEN ANO = '2022' THEN TOTAL_SINISTRADOS ELSE 0 END AS TOTAL_SINISTRADOS_2022,


FROM TABELA1
)

SELECT 
 DSC_FAIXA_ETARIA_BENEFICIARIO,
    DSC_CLASSIFICACAO_PRESTADOR,
    SGL_UF_PRESTADOR,
   ANO
  , MES
  , ANO_MES
  , BASE 
  , DSC_CARTEIRA_EMPRESA
  , NME_PLANO_AJUSTADO
,
SUM(TOTAL_SINISTRO_2018) AS TOTAL_SINISTRO_2018,
SUM(TOTAL_SINISTRO_2019) AS TOTAL_SINISTRO_2019,
SUM(TOTAL_SINISTRO_2020) AS TOTAL_SINISTRO_2020,
SUM(TOTAL_SINISTRO_2021) AS TOTAL_SINISTRO_2021,
SUM(TOTAL_SINISTRO_2022) AS TOTAL_SINISTRO_2022,

SUM(TOTAL_QUANTIDADE_2018) AS TOTAL_QUANTIDADE_2018,
SUM(TOTAL_QUANTIDADE_2019) AS TOTAL_QUANTIDADE_2019,
SUM(TOTAL_QUANTIDADE_2020) AS TOTAL_QUANTIDADE_2020,
SUM(TOTAL_QUANTIDADE_2021) AS TOTAL_QUANTIDADE_2021,
SUM(TOTAL_QUANTIDADE_2022) AS TOTAL_QUANTIDADE_2022,

SUM(TOTAL_SINISTRADOS_2018) AS TOTAL_SINISTRADOS_2018,
SUM(TOTAL_SINISTRADOS_2019) AS TOTAL_SINISTRADOS_2019,
SUM(TOTAL_SINISTRADOS_2020) AS TOTAL_SINISTRADOS_2020,
SUM(TOTAL_SINISTRADOS_2021) AS TOTAL_SINISTRADOS_2021,
SUM(TOTAL_SINISTRADOS_2022) AS TOTAL_SINISTRADOS_2022,

-- VAR ABS TOTAL SINISTRO
SUM(TOTAL_SINISTRO_2019) - SUM(TOTAL_SINISTRO_2018) AS VAR_ABS_TOTAL_SINISTRO_19_18,
SUM(TOTAL_SINISTRO_2020) - SUM(TOTAL_SINISTRO_2019) AS VAR_ABS_TOTAL_SINISTRO_20_19,
SUM(TOTAL_SINISTRO_2021) - SUM(TOTAL_SINISTRO_2020) AS VAR_ABS_TOTAL_SINISTRO_21_20,
SUM(TOTAL_SINISTRO_2022) - SUM(TOTAL_SINISTRO_2021) AS VAR_ABS_TOTAL_SINISTRO_22_21,
SUM(TOTAL_SINISTRO_2022) - SUM(TOTAL_SINISTRO_2019) AS VAR_ABS_TOTAL_SINISTRO_22_19,

-- VAR ABS QTD ATENDIMENTO 
SUM(TOTAL_QUANTIDADE_2019) - SUM(TOTAL_QUANTIDADE_2018) AS VAR_ABS_TOTAL_QUANTIDADE_19_18,
SUM(TOTAL_QUANTIDADE_2020) - SUM(TOTAL_QUANTIDADE_2019) AS VAR_ABS_TOTAL_QUANTIDADE_20_19,
SUM(TOTAL_QUANTIDADE_2021) - SUM(TOTAL_QUANTIDADE_2020) AS VAR_ABS_TOTAL_QUANTIDADE_21_20,
SUM(TOTAL_QUANTIDADE_2022) - SUM(TOTAL_QUANTIDADE_2021) AS VAR_ABS_TOTAL_QUANTIDADE_22_21,
SUM(TOTAL_QUANTIDADE_2022) - SUM(TOTAL_QUANTIDADE_2019) AS VAR_ABS_TOTAL_QUANTIDADE_22_19,

-- VAR ABS QTD SINISTRADOS

SUM(TOTAL_SINISTRADOS_2019) - SUM(TOTAL_SINISTRADOS_2018) AS VAR_ABS_TOTAL_SINISTRADOS_19_18,
SUM(TOTAL_SINISTRADOS_2020) - SUM(TOTAL_SINISTRADOS_2019) AS VAR_ABS_TOTAL_SINISTRADOS_20_19,
SUM(TOTAL_SINISTRADOS_2021) - SUM(TOTAL_SINISTRADOS_2020) AS VAR_ABS_TOTAL_SINISTRADOS_21_20,
SUM(TOTAL_SINISTRADOS_2022) - SUM(TOTAL_SINISTRADOS_2021) AS VAR_ABS_TOTAL_SINISTRADOS_22_21,
SUM(TOTAL_SINISTRADOS_2022) - SUM(TOTAL_SINISTRADOS_2019) AS VAR_ABS_TOTAL_SINISTRADOS_22_19,

FROM TABELA2
GROUP BY 1,2,3,4,5,6,7,8,9
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------
























--OBSERVAÇÃO IMPORTANTE: NA BASE DE EXPOSTOS,EXISTE O CÁLCULO DE DE PESO, QUE CALCULA O PERCENTUAL DE EXPOSTOS 
--DE CADA PLANO EM RELAÇÃO AO TOTAL DE EXPOSTOS NAQUELE ANO E NAQUELE MÊS.



--DENTRO DO PAINEL DO DATASTUDIO FAZEMOS A JUNÇÃO DA BASE AMBULATORIAL E DA BASE DE INTERNAÇÃO
--COM A COLUNA DE PESO DA PLANILHA DE EXPOSTOS, A CHAVE USADA É A CONCATENAÇÃO DE ANO, MES, CARTEIRA, PLANO, FAIXA ETARIA

--NA PLANILHA DE EXPOSTOS EXISTEM CHAVES QUE NÃO TEM NAS PLANILHAS AMBULATORIAL E INTERNAÇÃO, POR ISSO,
--INCLUÍMOS NESSAS PLANILHAS TOS OS ANO, MES, CARTEIRA E PLANOS QUE TEM NA BASE DE EXPOSTOS E NÃO TEM NAS
--BASES DE FATURAMENTO AMBULATORIAL E INT.



--DEPOIS DE CRIAR ESSE ARQUIVO, FAZEMOS O UNION ALL DA BASE AMBULATORIAL E INT COM ESSE ARQUIVO,
--PARA QUE ESSAS BASES CONTENHA TODAS AS CHAVES QUE EXISTE NA PLANILHA DE EXPOSTOS


------------UNION PARA INCLUIR ANOMESCARTPLANO NA BASE AMBULATORIAL------------------------------------



CREATE OR REPLACE TABLE SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TOTAL_ANALISE_DOR_DATASTUDIO_LA
OPTIONS (
    EXPIRATION_TIMESTAMP=TIMESTAMP_ADD(CURRENT_TIMESTAMP(), INTERVAL 10 DAY)
)
AS

WITH ANOMESCARTPLANO AS(
#---------------------------------------------------------------------------------------------------------------------------
#SELECIONA TODOS OS ANOMESCARTPLANO QUE TEM NA TABELA EXPOSTOS E NÃO TEM NA TABELA INTERNADOS
WITH A AS
(SELECT DISTINCT
ANO,MES,ANO_MES,DSC_CARTEIRA_EMPRESA,NME_PLANO_AJUSTADO,CONCAT(ANO_MES,DSC_CARTEIRA_EMPRESA,NME_PLANO_AJUSTADO) AS CHAVE
FROM SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TOTAL_ANALISE_DOR_DATASTUDIO_LA) 

SELECT
B.*

FROM A TAB

RIGHT JOIN

(SELECT DISTINCT ANO,MES,ANO_MES,CARTEIRA,PLANO,CONCAT(ANO_MES,CARTEIRA,PLANO) AS CHAVE FROM SANDBOX_GERAC.TB_EXPOSTOS_FINAL_LA WHERE PLANO IS NOT NULL) B

USING(CHAVE)

WHERE TAB.CHAVE IS NULL
#---------------------------------------------------------------------------------------------------------------------------
)

SELECT 
CAST(NULL AS STRING) as DSC_FAIXA_ETARIA_BENEFICIARIO,
CAST(NULL AS STRING) AS DSC_CLASSIFICACAO_PRESTADOR,
CAST(NULL AS STRING) as SGL_UF_PRESTADOR,
CAST(ANO AS STRING) as ANO,
CAST(MES AS STRING) AS MES,
CAST(ANO_MES AS STRING) AS ANO_MES,
CAST(NULL AS STRING) AS BASE,
CAST(CARTEIRA AS STRING) AS DSC_CARTEIRA_EMPRESA,
CAST(PLANO AS STRING) AS NME_PLANO_AJUSTADO,
CAST(NULL AS NUMERIC) AS TOTAL_SINISTRO_2018,
CAST(NULL AS NUMERIC) AS TOTAL_SINISTRO_2019,
CAST(NULL AS NUMERIC) AS TOTAL_SINISTRO_2020,
CAST(NULL AS NUMERIC) AS TOTAL_SINISTRO_2021,
CAST(NULL AS NUMERIC) AS TOTAL_SINISTRO_2022,
CAST(NULL AS INTEGER) AS TOTAL_QUANTIDADE_2018,
CAST(NULL AS INTEGER) AS TOTAL_QUANTIDADE_2019,
CAST(NULL AS INTEGER) AS TOTAL_QUANTIDADE_2020,
CAST(NULL AS INTEGER) AS TOTAL_QUANTIDADE_2021,
CAST(NULL AS INTEGER) AS TOTAL_QUANTIDADE_2022,
CAST(NULL AS INTEGER) AS TOTAL_SINISTRADOS_2018,
CAST(NULL AS INTEGER) AS TOTAL_SINISTRADOS_2019,
CAST(NULL AS INTEGER) AS TOTAL_SINISTRADOS_2020,
CAST(NULL AS INTEGER) AS TOTAL_SINISTRADOS_2021,
CAST(NULL AS INTEGER) AS TOTAL_SINISTRADOS_2022,
CAST(NULL AS NUMERIC) AS VAR_ABS_TOTAL_SINISTRO_19_18,
CAST(NULL AS NUMERIC) AS VAR_ABS_TOTAL_SINISTRO_20_19,
CAST(NULL AS NUMERIC) AS VAR_ABS_TOTAL_SINISTRO_21_20,
CAST(NULL AS NUMERIC) AS VAR_ABS_TOTAL_SINISTRO_22_21,
CAST(NULL AS NUMERIC) AS VAR_ABS_TOTAL_SINISTRO_22_19,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_QUANTIDADE_19_18,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_QUANTIDADE_20_19,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_QUANTIDADE_21_20,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_QUANTIDADE_22_21,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_QUANTIDADE_22_19,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_SINISTRADOS_19_18,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_SINISTRADOS_20_19,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_SINISTRADOS_21_20,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_SINISTRADOS_22_21,
CAST(NULL AS INTEGER) AS VAR_ABS_TOTAL_SINISTRADOS_22_19,


FROM ANOMESCARTPLANO

UNION ALL

SELECT 
DSC_FAIXA_ETARIA_BENEFICIARIO,
DSC_CLASSIFICACAO_PRESTADOR,
SGL_UF_PRESTADOR,
ANO,
MES,
ANO_MES,
BASE,
DSC_CARTEIRA_EMPRESA,
NME_PLANO_AJUSTADO,
TOTAL_SINISTRO_2018,
TOTAL_SINISTRO_2019,
TOTAL_SINISTRO_2020,
TOTAL_SINISTRO_2021,
TOTAL_SINISTRO_2022,
TOTAL_QUANTIDADE_2018,
TOTAL_QUANTIDADE_2019,
TOTAL_QUANTIDADE_2020,
TOTAL_QUANTIDADE_2021,
TOTAL_QUANTIDADE_2022,
TOTAL_SINISTRADOS_2018,
TOTAL_SINISTRADOS_2019,
TOTAL_SINISTRADOS_2020,
TOTAL_SINISTRADOS_2021,
TOTAL_SINISTRADOS_2022,
VAR_ABS_TOTAL_SINISTRO_19_18,
VAR_ABS_TOTAL_SINISTRO_20_19,
VAR_ABS_TOTAL_SINISTRO_21_20,
VAR_ABS_TOTAL_SINISTRO_22_21,
VAR_ABS_TOTAL_SINISTRO_22_19,
VAR_ABS_TOTAL_QUANTIDADE_19_18,
VAR_ABS_TOTAL_QUANTIDADE_20_19,
VAR_ABS_TOTAL_QUANTIDADE_21_20,
VAR_ABS_TOTAL_QUANTIDADE_22_21,
VAR_ABS_TOTAL_QUANTIDADE_22_19,
VAR_ABS_TOTAL_SINISTRADOS_19_18,
VAR_ABS_TOTAL_SINISTRADOS_20_19,
VAR_ABS_TOTAL_SINISTRADOS_21_20,
VAR_ABS_TOTAL_SINISTRADOS_22_21,
VAR_ABS_TOTAL_SINISTRADOS_22_19,
FROM `self-service-saude.SANDBOX_GERAC.LT_GT_SINISTRO_BASE_TOTAL_ANALISE_DOR_DATASTUDIO_LA`